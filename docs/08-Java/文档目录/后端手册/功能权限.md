ç›®å½•

# åŠŸèƒ½æƒé™

## [#](#ğŸ‘-ç›¸å…³è§†é¢‘æ•™ç¨‹) ğŸ‘ ç›¸å…³è§†é¢‘æ•™ç¨‹

*   [åŠŸèƒ½æƒé™ 01ï¼šå¦‚ä½•è®¾è®¡ä¸€å¥—æƒé™ç³»ç»Ÿï¼Ÿ (opens new window)](https://t.zsxq.com/07nYzrfyz)
*   [åŠŸèƒ½æƒé™ 02ï¼šå¦‚ä½•å®ç°èœå•çš„åˆ›å»ºï¼Ÿ (opens new window)](https://t.zsxq.com/07IuNBmAq)
*   [åŠŸèƒ½æƒé™ 03ï¼šå¦‚ä½•å®ç°è§’è‰²çš„åˆ›å»ºï¼Ÿ (opens new window)](https://t.zsxq.com/07f6AuJuZ)
*   [åŠŸèƒ½æƒé™ 04ï¼šå¦‚ä½•ç»™ç”¨æˆ·åˆ†é…æƒé™ â€”â€” å°†èœå•èµ‹äºˆè§’è‰²ï¼Ÿ (opens new window)](https://t.zsxq.com/07uJqV7Y3)
*   [åŠŸèƒ½æƒé™ 05ï¼šå¦‚ä½•ç»™ç”¨æˆ·åˆ†é…æƒé™ â€”â€” å°†è§’è‰²èµ‹äºˆç”¨æˆ·ï¼Ÿ (opens new window)](https://t.zsxq.com/07YBe6QjA)
*   [åŠŸèƒ½æƒé™ 06ï¼šåç«¯å¦‚ä½•å®ç° URL æƒé™çš„æ ¡éªŒï¼Ÿ (opens new window)](https://t.zsxq.com/072ZVJurz)
*   [åŠŸèƒ½æƒé™ 07ï¼šå‰ç«¯å¦‚ä½•å®ç°èœå•çš„åŠ¨æ€åŠ è½½ï¼Ÿ (opens new window)](https://t.zsxq.com/07rnMRRn2)
*   [åŠŸèƒ½æƒé™ 08ï¼šå‰ç«¯å¦‚ä½•å®ç°æŒ‰é’®çš„æƒé™æ ¡éªŒï¼Ÿ (opens new window)](https://t.zsxq.com/072JeIUfY)

## [#](#_1-rbac-æƒé™æ¨¡å‹) 1. RBAC æƒé™æ¨¡å‹

ç³»ç»Ÿé‡‡ç”¨ RBAC æƒé™æ¨¡å‹ï¼Œå…¨ç§°æ˜¯ Role-Based Access Control åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚

![æƒé™æ¨¡å‹](./static/01.png)

ç®€å•æ¥è¯´ï¼Œæ¯ä¸ªç”¨æˆ·æ‹¥æœ‰è‹¥å¹²è§’è‰²ï¼Œæ¯ä¸ªè§’è‰²æ‹¥æœ‰è‹¥å¹²ä¸ªèœå•ï¼Œèœå•ä¸­å­˜åœ¨èœå•æƒé™ã€æŒ‰é’®æƒé™ã€‚è¿™æ ·ï¼Œå°±å½¢æˆäº† **â€œç”¨æˆ·<->è§’è‰²<->èœå•â€** çš„æˆæƒæ¨¡å‹ã€‚ åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œç”¨æˆ·ä¸è§’è‰²ã€è§’è‰²ä¸èœå•ä¹‹é—´æ„æˆäº†å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼š

![æƒé™æ¨¡å‹](./static/02.png)

## [#](#_2-token-è®¤è¯æœºåˆ¶) 2. Token è®¤è¯æœºåˆ¶

å®‰å…¨æ¡†æ¶ä½¿ç”¨çš„æ˜¯ [Spring Security (opens new window)](https://www.iocoder.cn/Spring-Boot/Spring-Security/?yudao) + Token æ–¹æ¡ˆï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Token è®¤è¯æœºåˆ¶](./static/03.png)

â‘  å‰ç«¯è°ƒç”¨ç™»å½•æ¥å£ï¼Œä½¿ç”¨è´¦å·å¯†ç è·å¾—åˆ°è®¤è¯ Tokenã€‚å“åº”ç¤ºä¾‹å¦‚ä¸‹ï¼š

```json
{
  "code":0,
  "msg":"",
  "data":{
    "token":"d2a3cdbc6c53470db67a582bd115103f"
  }
}

```

*   ç®¡ç†åå°çš„ç™»å½•å®ç°ï¼Œå¯è§ [ä»£ç  (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/AuthController.java#L56-L63)
*   ç”¨æˆ· App çš„ç™»å½•å®ç°ï¼Œå¯è§ [ä»£ç  (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-member/yudao-module-member-biz/src/main/java/cn/iocoder/yudao/module/member/controller/app/auth/AppAuthController.java#L34-L41)

ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Spring Security å†…ç½®çš„è¡¨å•ç™»å½•ï¼Ÿ

Spring Security çš„ç™»å½•æ‹“å±•èµ·æ¥ä¸æ–¹ä¾¿ï¼Œä¾‹å¦‚è¯´éªŒè¯ç ã€ä¸‰æ–¹ç™»å½•ç­‰ç­‰ã€‚

Token å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¯¹åº” `system_oauth2_access_token` è®¿é—®ä»¤ç‰Œè¡¨çš„ `id` å­—æ®µã€‚è€ƒè™‘åˆ°è®¿é—®çš„æ€§èƒ½ï¼Œç¼“å­˜åœ¨ Redis çš„ [`oauth2_access_token:%s` (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/redis/RedisKeyConstants.java#L21) é”®ä¸­ã€‚

ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JWT(JSON Web Token)ï¼Ÿ

JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œæ— æ³•å®ç° Token çš„ä½œåºŸï¼Œä¾‹å¦‚è¯´ç”¨æˆ·ç™»å‡ºç³»ç»Ÿã€ä¿®æ”¹å¯†ç ç­‰ç­‰åœºæ™¯ã€‚

æ¨èé˜…è¯» [ã€Šè¿˜åˆ†ä¸æ¸… Cookieã€Sessionã€Tokenã€JWTï¼Ÿã€‹ (opens new window)](https://www.iocoder.cn/Fight/Confused-about-cookies-sessions,-Tokens-JWT/?yudao) æ–‡ç« ã€‚

é»˜è®¤é…ç½®ä¸‹ï¼ŒToken æœ‰æ•ˆæœŸä¸º 30 å¤©ï¼Œå¯é€šè¿‡ `system_oauth2_client` è¡¨ä¸­ `client_id = default` çš„è®°å½•è¿›è¡Œè‡ªå®šä¹‰ï¼š

![ è¡¨](./static/04.png)

*   ä¿®æ”¹ `access_token_validity_seconds` å­—æ®µï¼Œè®¾ç½®è®¿é—®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 1800 ç§’ = 30 åˆ†é’Ÿ
*   ä¿®æ”¹ `refresh_token_validity_seconds` å­—æ®µï¼Œè®¾ç½®åˆ·æ–°ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 2592000 ç§’ = 30 å¤©

â‘¡ å‰ç«¯è°ƒç”¨å…¶å®ƒæ¥å£ï¼Œéœ€è¦åœ¨è¯·æ±‚å¤´å¸¦ä¸Š Token è¿›è¡Œè®¿é—®ã€‚è¯·æ±‚å¤´æ ¼å¼å¦‚ä¸‹ï¼š

```bash
### Authorization: Bearer ç™»å½•æ—¶è¿”å›çš„ Token
Authorization: Bearer d2a3cdbc6c53470db67a582bd115103f

```

*   å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯è§ [TokenAuthenticationFilter (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/filter/TokenAuthenticationFilter.java) è¿‡æ»¤å™¨

è€ƒè™‘åˆ°ä½¿ç”¨ Postmanã€Swagger è°ƒè¯•æ¥å£æ–¹ä¾¿ï¼Œæä¾›äº† **Token çš„æ¨¡æ‹Ÿæœºåˆ¶**ã€‚è¯·æ±‚å¤´æ ¼å¼å¦‚ä¸‹ï¼š

```bash
### Authorization: Bearer testç”¨æˆ·ç¼–å·
Authorization: Bearer test1

```

å…¶ä¸­ `"test"` å¯è‡ªå®šä¹‰ï¼Œé…ç½®é¡¹å¦‚ä¸‹ï¼š

```yaml
### application-local.yaml

yudao:
  security:
    mock-enable: true # æ˜¯å¦å¼€å¯ Token çš„æ¨¡æ‹Ÿæœºåˆ¶
    mock-secret: test # Token æ¨¡æ‹Ÿæœºåˆ¶çš„ Token å‰ç¼€

```

## [#](#_3-æƒé™æ³¨è§£) 3. æƒé™æ³¨è§£
### [#](#_3-1-preauthorize-æ³¨è§£) 3.1 @PreAuthorize æ³¨è§£

[`@PreAuthorize` (opens new window)](https://github.com/spring-projects/spring-security/blob/main/core/src/main/java/org/springframework/security/access/prepost/PreAuthorize.java) æ˜¯ Spring Security å†…ç½®çš„**å‰ç½®**æƒé™æ³¨è§£ï¼Œæ·»åŠ åœ¨**æ¥å£æ–¹æ³•**ä¸Šï¼Œå£°æ˜éœ€è¦çš„æƒé™ï¼Œå®ç°è®¿é—®æƒé™çš„æ§åˆ¶ã€‚

â‘  åŸºäºã€æƒé™æ ‡è¯†ã€‘çš„æƒé™æ§åˆ¶

æƒé™æ ‡è¯†ï¼Œå¯¹åº” `system_menu` è¡¨çš„ `permission` å­—æ®µï¼Œæ¨èæ ¼å¼ä¸º `${ç³»ç»Ÿ}:${æ¨¡å—}:${æ“ä½œ}`ï¼Œä¾‹å¦‚è¯´ `system:admin:add` æ ‡è¯† system æœåŠ¡çš„æ·»åŠ ç®¡ç†å‘˜ã€‚

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// ç¬¦åˆ system:user:list æƒé™è¦æ±‚
@PreAuthorize("@ss.hasPermission('system:user:list')")

// ç¬¦åˆ system:user:add æˆ– system:user:edit æƒé™è¦æ±‚å³å¯
@PreAuthorize("@ss.hasAnyPermissions('system:user:add,system:user:edit')")

```

â‘¡ åŸºäºã€è§’è‰²æ ‡è¯†ã€‘çš„æƒé™æ§åˆ¶

æƒé™æ ‡è¯†ï¼Œå¯¹åº” `system_role` è¡¨çš„ `code` å­—æ®µï¼Œ ä¾‹å¦‚è¯´ `super_admin` è¶…çº§ç®¡ç†å‘˜ã€`tenant_admin` ç§Ÿæˆ·ç®¡ç†å‘˜ã€‚

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// å±äº user è§’è‰²
@PreAuthorize("@ss.hasRole('user')")

// å±äº user æˆ–è€… admin ä¹‹ä¸€
@PreAuthorize("@ss.hasAnyRoles('user', 'admin')")

```

å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

å½“ `@PreAuthorize` æ³¨è§£é‡Œçš„ Spring EL è¡¨è¾¾å¼è¿”å› `false` æ—¶ï¼Œè¡¨ç¤ºæ²¡æœ‰æƒé™ã€‚

è€Œ `@PreAuthorize("@ss.hasPermission('system:user:list')")` è¡¨ç¤ºè°ƒç”¨ Bean åå­—ä¸º `ss` çš„ `#hasPermission(...)` æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°ä¸º `"system:user:list"` å­—ç¬¦ä¸²ã€‚`ss` å¯¹åº”çš„ Bean æ˜¯ [PermissionServiceImpl (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/permission/PermissionServiceImpl.java#L43) ç±»ï¼Œæ‰€ä»¥ä½ åªéœ€è¦å»çœ‹è¯¥æ–¹æ³•çš„[å®ç°ä»£ç  (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/permission/PermissionServiceImpl.java#L293-L326)ã€‚

### [#](#_3-2-preauthenticated-æ³¨è§£) 3.2 @PreAuthenticated æ³¨è§£

[`@PreAuthenticated` (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/annotations/PreAuthenticated.java) æ˜¯é¡¹ç›®è‡ªå®šä¹‰çš„**è®¤è¯**æ³¨è§£ï¼Œæ·»åŠ åœ¨**æ¥å£æ–¹æ³•**ä¸Šï¼Œå£°æ˜ç™»å½•çš„ç”¨æˆ·æ‰å…è®¸è®¿é—®ã€‚

ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œé’ˆå¯¹ç”¨æˆ· App çš„ `/app-app/**` çš„ RESTful API æ¥å£ï¼Œé»˜è®¤æ˜¯æ— éœ€ç™»å½•çš„ï¼Œé€šè¿‡ `@PreAuthenticated` å£°æ˜å®ƒéœ€è¦è¿›è¡Œç™»å½•ã€‚ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// AppAuthController.java

@PostMapping("/update-password")
@Operation(summary = "ä¿®æ”¹ç”¨æˆ·å¯†ç ", description = "ç”¨æˆ·ä¿®æ”¹å¯†ç æ—¶ä½¿ç”¨")
@PreAuthenticated
public CommonResult<Boolean> updatePassword(@RequestBody @Valid AppAuthUpdatePasswordReqVO reqVO) {
    // ... çœç•¥ä»£ç 
}

```

å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯è§ [PreAuthenticatedAspect (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/aop/PreAuthenticatedAspect.java) ç±»ã€‚

## [#](#_4-è‡ªå®šä¹‰æƒé™é…ç½®) 4. è‡ªå®šä¹‰æƒé™é…ç½®

é»˜è®¤é…ç½®ä¸‹ï¼Œç®¡ç†åå°çš„ `/admin-api/**` æ‰€æœ‰ API æ¥å£éƒ½**å¿…é¡»**ç™»å½•åæ‰å…è®¸è®¿é—®ï¼Œç”¨æˆ· App çš„ `/app-api/**` æ‰€æœ‰ API æ¥å£**æ— éœ€**ç™»å½•å°±å¯ä»¥è®¿é—®ã€‚

å¦‚ä¸‹æƒ³è¦è‡ªå®šä¹‰æƒé™é…ç½®ï¼Œè®¾ç½®å®šä¹‰ API æ¥å£å¯ä»¥åŒ¿åï¼ˆä¸ç™»å½•ï¼‰è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹å¼ï¼š

### [#](#_4-1-æ–¹å¼ä¸€-è‡ªå®šä¹‰-authorizerequestscustomizer-å®ç°) 4.1 æ–¹å¼ä¸€ï¼šè‡ªå®šä¹‰ AuthorizeRequestsCustomizer å®ç°

æ¯ä¸ª Maven Module å¯ä»¥å®ç°è‡ªå®šä¹‰çš„ [AuthorizeRequestsCustomizer (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/config/YudaoWebSecurityConfigurerAdapter.java) Beanï¼Œé¢å¤–å®šä¹‰æ¯ä¸ª Module çš„ API æ¥å£çš„è®¿é—®è§„åˆ™ã€‚ä¾‹å¦‚è¯´ `yudao-module-infra` æ¨¡å—çš„ [SecurityConfiguration (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-infra/yudao-module-infra-biz/src/main/java/cn/iocoder/yudao/module/infra/framework/security/config/SecurityConfiguration.java) ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

â‘  JDK 8 + Spring Boot 2.X ç‰ˆæœ¬ï¼š

```java
@Configuration("infraSecurityConfiguration")
public class SecurityConfiguration {

    @Value("${spring.boot.admin.context-path:''}")
    private String adminSeverContextPath;

    @Bean("infraAuthorizeRequestsCustomizer")
    public AuthorizeRequestsCustomizer authorizeRequestsCustomizer() {
        return new AuthorizeRequestsCustomizer() {

            @Override
            public void customize(ExpressionUrlAuthorizationConfigurer<HttpSecurity>.ExpressionInterceptUrlRegistry registry) {
                // Swagger æ¥å£æ–‡æ¡£
                registry.antMatchers("/swagger-ui.html").anonymous()
                        .antMatchers("/swagger-resources/**").anonymous()
                        .antMatchers("/webjars/**").anonymous()
                        .antMatchers("/*/api-docs").anonymous();
                // Spring Boot Actuator çš„å®‰å…¨é…ç½®
                registry.antMatchers("/actuator").anonymous()
                        .antMatchers("/actuator/**").anonymous();
                // Druid ç›‘æ§
                registry.antMatchers("/druid/**").anonymous();
                // Spring Boot Admin Server çš„å®‰å…¨é…ç½®
                registry.antMatchers(adminSeverContextPath).anonymous()
                        .antMatchers(adminSeverContextPath + "/**").anonymous();
            }

        };
    }

}

```

â‘¡ JDK 17 + Spring Boot 3.X ç‰ˆæœ¬ï¼š

```java
@Configuration(proxyBeanMethods = false, value = "infraSecurityConfiguration")
public class SecurityConfiguration {

    @Value("${spring.boot.admin.context-path:''}")
    private String adminSeverContextPath;

    @Bean("infraAuthorizeRequestsCustomizer")
    public AuthorizeRequestsCustomizer authorizeRequestsCustomizer() {
        return new AuthorizeRequestsCustomizer() {

            @Override
            public void customize(AuthorizeHttpRequestsConfigurer<HttpSecurity>.AuthorizationManagerRequestMatcherRegistry registry) {
                // Swagger æ¥å£æ–‡æ¡£
                registry.requestMatchers("/v3/api-docs/**").permitAll()
                        .requestMatchers("/swagger-ui.html").permitAll()
                        .requestMatchers("/swagger-ui/**").permitAll()
                        .requestMatchers("/swagger-resources/**").permitAll()
                        .requestMatchers("/webjars/**").permitAll()
                        .requestMatchers("/*/api-docs").permitAll();
                // Spring Boot Actuator çš„å®‰å…¨é…ç½®
                registry.requestMatchers("/actuator").permitAll()
                        .requestMatchers("/actuator/**").permitAll();
                // Druid ç›‘æ§
                registry.requestMatchers("/druid/**").permitAll();
                // Spring Boot Admin Server çš„å®‰å…¨é…ç½®
                registry.requestMatchers(adminSeverContextPath).permitAll()
                        .requestMatchers(adminSeverContextPath + "/**").permitAll();
                // æ–‡ä»¶è¯»å–
                registry.requestMatchers(buildAdminApi("/infra/file/*/get/**")).permitAll();
            }

        };
    }

}

```

å‹æƒ…æç¤º

*   `permitAll()` æ–¹æ³•ï¼šæ‰€æœ‰ç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—®ï¼ŒåŒ…æ‹¬å¸¦ä¸Š Token è®¿é—®
*   `anonymous()` æ–¹æ³•ï¼šåŒ¿åç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—®ï¼Œå¸¦ä¸Š Token è®¿é—®ä¼šæŠ¥é”™

å¦‚æœä½ å¯¹ Spring Security äº†è§£ä¸å¤šï¼Œå¯ä»¥é˜…è¯»è‰¿è‰¿å†™çš„ [ã€ŠèŠ‹é“ Spring Boot å®‰å…¨æ¡†æ¶ Spring Security å…¥é—¨ ã€‹ (opens new window)](https://www.iocoder.cn/Spring-Boot/Spring-Security/?yudao) æ–‡ç« ã€‚

### [#](#_4-2-æ–¹å¼äºŒ-permitall-æ³¨è§£) 4.2 æ–¹å¼äºŒï¼š`@PermitAll` æ³¨è§£

åœ¨ API æ¥å£ä¸Šæ·»åŠ  [`@PermitAll` (opens new window)](https://javaee.github.io/javaee-spec/javadocs/javax/annotation/security/PermitAll.html) æ³¨è§£ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// FileController.java
@GetMapping("/{configId}/get/{path}")
@PermitAll
public void getFileContent(HttpServletResponse response,
                           @PathVariable("configId") Long configId,
                           @PathVariable("path") String path) throws Exception {
    // ...
}

```

### [#](#_4-3-æ–¹å¼ä¸‰-yudao-security-permit-all-urls-é…ç½®é¡¹) 4.3 æ–¹å¼ä¸‰ï¼š`yudao.security.permit-all-urls` é…ç½®é¡¹

åœ¨ `application.yaml` é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ `yudao.security.permit-all-urls` é…ç½®é¡¹è®¾ç½®ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
yudao:
  security:
    permit-all-urls:
      - /admin-ui/** # /resources/admin-ui ç›®å½•ä¸‹çš„é™æ€èµ„æº
      - /admin-api/xxx/yyy

```