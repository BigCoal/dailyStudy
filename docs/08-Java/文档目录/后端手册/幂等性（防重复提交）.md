ç›®å½•

# å¹‚ç­‰æ€§ï¼ˆé˜²é‡å¤æäº¤ï¼‰

[`yudao-spring-boot-starter-protection` (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/) æŠ€æœ¯ç»„ä»¶ï¼Œç”±å®ƒçš„ [`idempotent` (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/idempotent/) åŒ…ï¼Œæä¾›å£°æ˜å¼çš„å¹‚ç­‰ç‰¹æ€§ï¼Œå¯é˜²æ­¢é‡å¤è¯·æ±‚ã€‚ä¾‹å¦‚è¯´ï¼Œç”¨æˆ·å¿«é€Ÿçš„åŒå‡»äº†æŸä¸ªæŒ‰é’®ï¼Œå‰ç«¯æ²¡æœ‰ç¦ç”¨è¯¥æŒ‰é’®ï¼Œå¯¼è‡´å‘é€äº†ä¸¤æ¬¡é‡å¤çš„è¯·æ±‚ã€‚

```java
// UserController.java

@Idempotent(timeout = 10, timeUnit = TimeUnit.SECONDS, message = "æ­£åœ¨æ·»åŠ ç”¨æˆ·ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤")
@PostMapping("/user/create")
public String createUser(User user){
    userService.createUser(user);
    return "æ·»åŠ æˆåŠŸ";
}

```

*   æ¯ 10 ç§’é’Ÿï¼Œæ‰€æœ‰ç”¨æˆ·ï¼Œåªèƒ½æ“ä½œä¸€æ¬¡

ç–‘é—®ï¼šå¦‚æœæƒ³æŒ‰ç…§æ¯ä¸ªç”¨æˆ·ï¼Œæˆ–è€…æ¯ä¸ª IPï¼Œé™åˆ¶è¯·æ±‚å‘¢ï¼Ÿ

å¯è®¾ç½®è¯¥æ³¨è§£çš„ `keyResolver` å±æ€§ï¼Œå¯é€‰æ‹©çš„æœ‰ï¼š

*   DefaultIdempotentKeyResolverï¼šå…¨å±€çº§åˆ«
*   UserIdempotentKeyResolverï¼šç”¨æˆ·çº§åˆ«
*   ExpressionIdempotentKeyResolverï¼šè‡ªå®šä¹‰çº§åˆ«ï¼Œé€šè¿‡ `keyArg` å±æ€§æŒ‡å®š Spring EL è¡¨è¾¾å¼

## [#](#_1-å®ç°åŸç†) 1. å®ç°åŸç†

å‹æƒ…æç¤ºï¼š

å®ƒçš„å®ç°åŸç†ï¼Œå’Œ [ã€Šè¯·æ±‚é™æµï¼ˆRateLimiterï¼‰ã€‹](/rate-limiter/) æ¯”è¾ƒæ¥è¿‘å“ˆã€‚

å®ƒçš„å®ç°åŸç†éå¸¸ç®€å•ï¼Œé’ˆå¯¹ç›¸åŒå‚æ•°çš„æ–¹æ³•ï¼Œä¸€æ®µæ—¶é—´å†…ï¼Œæœ‰ä¸”ä»…èƒ½æ‰§è¡Œä¸€æ¬¡ã€‚æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

â‘  åœ¨æ–¹æ³•æ‰§è¡Œå‰ï¼Œæ ¹æ®å‚æ•°å¯¹åº”çš„ Key æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ï¼š

*   å¦‚æœ**å­˜åœ¨**ï¼Œè¯´æ˜æ­£åœ¨æ‰§è¡Œä¸­ï¼Œåˆ™è¿›è¡ŒæŠ¥é”™ã€‚
*   å¦‚æœ**ä¸åœ¨**ï¼Œåˆ™è®¡ç®—å‚æ•°å¯¹åº”çš„ Keyï¼Œå­˜å‚¨åˆ° Redis ä¸­ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå³æ ‡è®°æ­£åœ¨æ‰§è¡Œä¸­ã€‚

é»˜è®¤å‚æ•°çš„ Redis Key çš„è®¡ç®—è§„åˆ™ç”± [DefaultIdempotentKeyResolver (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/idempotent/core/keyresolver/impl/DefaultIdempotentKeyResolver.java) å®ç°ï¼Œä½¿ç”¨ MD5(æ–¹æ³•å + æ–¹æ³•å‚æ•°)ï¼Œé¿å… Redis Key è¿‡é•¿ã€‚

â‘¡ æ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œ**ä¸ä¼š**ä¸»åŠ¨åˆ é™¤å‚æ•°å¯¹åº”çš„ Keyã€‚

å¦‚æœå¸Œæœ›ä¼š**ä¸»åŠ¨**åˆ é™¤ Keyï¼Œå¯ä»¥ä½¿ç”¨ [ã€Šå¼€å‘æŒ‡å— â€”â€” åˆ†å¸ƒå¼é”ã€‹](/distributed-lock) æä¾›çš„ `@Lock` æ¥å®ç°å¹‚ç­‰æ€§ã€‚

ğŸ™‚ ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œ`idempotent` åŒ…æä¾›çš„å¹‚ç­‰ç‰¹æ€§ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åŸºäº Redis å®ç°çš„åˆ†å¸ƒå¼é”ã€‚

â‘¢ å¦‚æœæ–¹æ³•æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¶…è¿‡ Key çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ™ Redis ä¼šè‡ªåŠ¨åˆ é™¤å¯¹åº”çš„ Keyã€‚å› æ­¤ï¼Œéœ€è¦å¤§æ¦‚è¯„ä¼°ä¸‹ï¼Œé¿å…æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡è¿‡æœŸæ—¶é—´ã€‚

â‘£ å¦‚æœæ–¹æ³•æ‰§è¡Œå‘ç”Ÿ Exception å¼‚å¸¸æ—¶ï¼Œé»˜è®¤ä¼šåˆ é™¤ Keyï¼Œé¿å…ä¸‹æ¬¡è¯·æ±‚æ— æ³•æ­£å¸¸æ‰§è¡Œï¼Œæ­¤å¤„å‚è€ƒ [ã€Šç¾å›¢ GTISã€‹ (opens new window)](https://tech.meituan.com/2016/09/29/distributed-system-mutually-exclusive-idempotence-cerberus-gtis.html) ã€‚

## [#](#_2-idempotent-æ³¨è§£) 2. `@Idempotent` æ³¨è§£

[`@Idempotent` (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/idempotent/core/annotation/Idempotent.java) æ³¨è§£ï¼Œå£°æ˜åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•éœ€è¦å¼€å¯å¹‚ç­‰æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

![ æ³¨è§£](./static/æ³¨è§£.png)

â‘  å¯¹åº”çš„ AOP åˆ‡é¢æ˜¯ [IdempotentAspect (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/idempotent/core/aop/IdempotentAspect.java) ç±»ï¼Œæ ¸å¿ƒå°± 10 è¡Œå·¦å³çš„ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![IdempotentAspect åˆ‡é¢](./static/IdempotentAspect.png)

â‘¡ å¯¹åº”çš„ Redis Key çš„å‰ç¼€æ˜¯ `idempotent:%s`ï¼Œå¯è§ [IdempotentRedisDAO (opens new window)](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-protection/src/main/java/cn/iocoder/yudao/framework/idempotent/core/redis/IdempotentRedisDAO.java) ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![IdempotentRedisDAO å­˜å‚¨](./static/IdempotentRedisDAO.png)

## [#](#_3-ä½¿ç”¨ç¤ºä¾‹) 3. ä½¿ç”¨ç¤ºä¾‹

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬å®ç° `/admin-api/infra/test-demo/get` RESTful API æ¥å£çš„å¹‚ç­‰æ€§ã€‚

â‘  åœ¨ `pom.xml` æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ `yudao-spring-boot-starter-protection` ä¾èµ–ã€‚

```xml
<dependency>
    <groupId>cn.iocoder.boot</groupId>
    <artifactId>yudao-spring-boot-starter-protection</artifactId>
</dependency>

```

â‘¡ åœ¨è¯¥ API æ¥å£çš„å¯¹åº”æ–¹æ³•ä¸Šï¼Œæ·»åŠ  `@Idempotent` æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// TestDemoController.java

@GetMapping("/get")
@Idempotent(timeout = 10, message = "é‡å¤è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•")
public CommonResult<TestDemoRespVO> getTestDemo(@RequestParam("id") Long id) {
    // ... çœç•¥ä»£ç 
}

```

â‘¢ è°ƒç”¨è¯¥ API æ¥å£ï¼Œæ‰§è¡ŒæˆåŠŸã€‚

![è°ƒç”¨æˆåŠŸ](./static/æ¡ˆä¾‹.png)

â‘£ å†æ¬¡è°ƒç”¨è¯¥ API æ¥å£ï¼Œè¢«å¹‚ç­‰æ€§æ‹¦æˆªï¼Œæ‰§è¡Œå¤±è´¥ã€‚

```json
{
  "code": 900,
  "data": null,
  "msg": "é‡å¤è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•"
}

```